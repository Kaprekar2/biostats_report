---
title: "生物統計学レポート"
author: "髙良力樹"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: united
    highlight: tango
    toc: true
    smart: false
#  pdf_document:
#    latex_engine: lualatex
#    toc: false
documentclass: bxjsarticle
classoption: lualatex
mainfont: ipaexg.ttf
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, ggtext, lattice, car)
```

## 環境要件

```{r}
sessionInfo()
```
環境は上記

## データ構造
まずデータの中身をhead関数で見てみると

```{r echo=FALSE}
head(barley)
```
variety・site・yearという3つの変数とそれに対応する変数yieldがある.

さらにデータ数自体に偏りがないかを確認すると各水準ごとに偏りはなく同じ数サンプリングされている.
```{r , echo=FALSE}
barley |> group_by(variety) |> tally() |> head()
barley |> group_by(site) |> tally() |> head()
barley |> group_by(year) |> tally() |> head()
```

## 1.オオムギ収量の箱ひげ図


<font-size: 18px;> 一つ目の要因である品種をx軸にとった箱ひげ図をまず見てみる.</font> 
```{r , echo=FALSE}
ggplot(barley, aes(x= variety, y=yield))+
  theme_bw()+
  geom_boxplot()+
  geom_jitter(aes(colour=year),width = 0.2)+
  scale_colour_manual(values = c("#D59B0A", "#DECA98"))+
  labs(
    title = "barley yield by variety",
    x = "variety",
    y = "yield [bu/ac]"
  )+
  theme(plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 12),
        plot.caption = element_text(size = 8)
  )+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))

```


プロットは自動的に中央値（第二四分位数）が昇順で整列されて描画されているため、一見品種によって収量が変化しているように見える.

しかし実点を見てみると、最大点から最小点までかなり広い範囲でばらついている(つまり分散が大きい)データが多い.
例えばSvantosaとTrebiだとほとんどの点の描画範囲は変わらないが、後者は最大点が非常に大きくまたデータが広範に散らばっている.


次に2つ目の要因である、栽培地のデータを見てみる.
```{r pressure, echo=FALSE}
ggplot(barley, aes(x= site, y=yield))+
  theme_bw()+
  geom_boxplot()+
  geom_jitter(aes(colour=year),width = 0.2)+
  scale_colour_manual(values = c("#D59B0A", "#DECA98"))+
  labs(
    title = "barley yield by site",
    x = "site",
    y = "yield [bu/ac]"
  )+
  theme(plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        axis.text.x = element_text(size = 10.5),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 12),
        plot.caption = element_text(size = 8)
  )+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

これをみると各サンプル集団の多くは狭い範囲に集中していて、中央値の差がはっきりあるように見える.

さらにもう一つの年度という変数に着目してみると、品種のグラフでは片方の年度だけ収量が高いといった偏りは特に見出せない.
一方で栽培地のグラフではばらけている栽培地と、Morrisのように年度で収量の平均が変動していそうに見えるサンプルもある.


これらのことから、オオムギの収量の変動要因は「**栽培地の影響が強く**」、「**品種の影響は栽培地による影響よりは弱そう**」であることがわかる.
また植物の育成に大きく効く、環境の変動要因である「年度」は「栽培地によって偏りがありそうだがはっきりわからない」といったことがわかる.


## 2.仮説の検定モデルと分散分析/補正

まずデータの形状から「栽培地と品種が収量に影響する」という仮説がたてられる.
また「栽培地と年度も関係があるかもしれない」という可能性がデータの概形から分かった.
この仮説の確からしさを示すために、「栽培地と品種（という変数）は収量に影響しない」という帰無仮説を立て、モデルを以下のように設定する.

```{r, echo=TRUE}

yield_nullmodel <- lm(yield ~ 1, data = barley)

yield_altmodel <- lm(yield ~ site + variety + 1 + site:year, data = barley)

```
上の回帰式は切片のみ（+誤差項）の栽培地と品種を考慮しないモデルで、下は栽培地による効果（ブロック効果）と品種（処理効果）という回帰係数を組み込み、またsiteとyearによる交互作用を考慮した上で収量が説明できると仮定したモデルである.

上記の各モデルに対して分散分析を行うと以下のようになる

```{r, echo=FALSE}

anova(yield_nullmodel)

car::Anova(yield_altmodel, type="III")

```


さらに水準間で多重比較を行っているため、Holm法による補正を行って各要素内の水準間で差があるかを比較する.

```{r, echo=FALSE}
pairwise.t.test(barley$yield, barley$variety, p.adj="holm") 
pairwise.t.test(barley$yield, barley$site, p.adj="holm") 
pairwise.t.test(barley$yield, barley$year, p.adj="holm") 
```

上記の結果から多重比較を考慮した上での結果が

## 3.分散分析の結果の解釈と交互作用について

#### 3-1.分散分析の結果について

